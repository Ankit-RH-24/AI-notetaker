<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>MedNote - Login</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-gradient-orange {
            background: linear-gradient(180deg, #FFDDC9 0%, #FFAF8A 100%);
        }
        .form-input {
            @apply w-full px-4 py-3 rounded-lg bg-white/80 border border-orange-200 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent;
        }
        .submit-button {
            @apply w-full bg-orange-500 text-white font-semibold py-3 rounded-full shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors duration-300 disabled:bg-orange-300;
        }
        .otp-input {
            @apply w-12 h-14 text-center text-2xl font-semibold form-input;
        }
    </style>
</head>
<body class="bg-gradient-orange text-gray-800">
    <div class="flex flex-col min-h-screen">
        <main class="flex-grow flex items-center justify-center p-6">
            <div class="w-full max-w-sm mx-auto bg-white/70 backdrop-blur-sm p-8 rounded-2xl shadow-lg border border-white/20">
                <div class="text-center mb-10">
                    <h1 class="text-4xl font-bold text-orange-600">Welcome</h1>
                    <p class="text-gray-700 mt-2">Enter your phone number to get started.</p>
                </div>
                
                <!-- Phone Number Form -->
                <form class="space-y-6" id="phone-form">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1" for="phone">Phone Number</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-orange-200 bg-gray-50 text-gray-600 text-sm">+91</span>
                            <input class="form-input rounded-l-none" id="phone" name="phone" placeholder="9876543210" type="tel"/>
                        </div>
                    </div>
                    <div id="recaptcha-container"></div>
                    <button class="submit-button" id="send-otp-btn" type="submit">Send Code</button>
                </form>

                <!-- OTP Verification Form (Initially Hidden) -->
                <form class="space-y-6 hidden" id="otp-form">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1" for="otp">Enter Verification Code</label>
                        <p class="text-sm text-gray-600 mb-4">We've sent a 6-digit code to <span class="font-semibold text-gray-800" id="phone-display"></span>. <button class="text-sm text-orange-600 hover:underline" id="change-phone-btn" type="button">Change</button></p>
                        <div class="flex justify-center space-x-2" id="otp-inputs">
                            <input class="otp-input" maxlength="1" type="text" inputmode="numeric" />
                            <input class="otp-input" maxlength="1" type="text" inputmode="numeric" />
                            <input class="otp-input" maxlength="1" type="text" inputmode="numeric" />
                            <input class="otp-input" maxlength="1" type="text" inputmode="numeric" />
                            <input class="otp-input" maxlength="1" type="text" inputmode="numeric" />
                            <input class="otp-input" maxlength="1" type="text" inputmode="numeric" />
                        </div>
                        <p class="text-red-500 text-sm mt-2 hidden" id="otp-error">Invalid OTP. Please try again.</p>
                    </div>
                    <button class="submit-button" id="verify-otp-btn" type="submit">Verify</button>
                    <p class="text-center text-sm text-gray-600">
                        Didn't receive the code? <button class="font-medium text-orange-600 hover:underline disabled:text-gray-400 disabled:cursor-not-allowed" id="resend-otp-btn" type="button" disabled>Resend</button>
                        <span class="text-gray-600" id="resend-timer"></span>
                    </p>
                </form>

                <p class="text-center text-xs text-gray-600 mt-8">
                    By continuing, you agree to our <a class="font-medium text-orange-600 hover:underline" href="#">Terms of Service</a> and <a class="font-medium text-orange-600 hover:underline" href="#">Privacy Policy</a>.
                </p>
            </div>
        </main>
        <footer class="py-4">
            <div class="w-36 h-1 bg-black rounded-full mx-auto opacity-80"></div>
        </footer>
    </div>

    <script>
        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyAh7ncrXf5tIic4fDfTrVlbrmWef6xSov8",
            authDomain: "otp-login-ca063.firebaseapp.com",
            projectId: "otp-login-ca063",
            storageBucket: "otp-login-ca063.firebasestorage.app",
            messagingSenderId: "380756162522",
            appId: "1:380756162522:web:b83ebed04a6d3f4dbbb2e3",
            measurementId: "G-GV0CRRMH5M"
        };
        firebase.initializeApp(firebaseConfig);

        // --- DOM Elements ---
        const phoneForm = document.getElementById('phone-form');
        const otpForm = document.getElementById('otp-form');
        const phoneInput = document.getElementById('phone');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const phoneDisplay = document.getElementById('phone-display');
        const changePhoneBtn = document.getElementById('change-phone-btn');
        const otpError = document.getElementById('otp-error');
        const otpInputsContainer = document.getElementById('otp-inputs');
        const otpInputs = otpInputsContainer.querySelectorAll('input');
        const resendOtpBtn = document.getElementById('resend-otp-btn');
        const resendTimer = document.getElementById('resend-timer');

        let confirmationResult = null;
        let recaptchaVerifier = null;

        // --- UI Switching Logic ---
        function showOtpForm(fullPhoneNumber) {
            phoneDisplay.textContent = fullPhoneNumber;
            phoneForm.classList.add('hidden');
            otpForm.classList.remove('hidden');
            otpInputs[0].focus();
            startResendTimer();
        }

        function showPhoneForm() {
            phoneForm.classList.remove('hidden');
            otpForm.classList.add('hidden');
            otpError.classList.add('hidden');
            otpInputs.forEach(input => input.value = '');
        }

        // --- Initialize reCAPTCHA ---
        function setupRecaptcha() {
            recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'invisible',
                'callback': (response) => {}
            });
            recaptchaVerifier.render();
        }
        window.onload = setupRecaptcha;

        // --- Event Listeners ---
        phoneForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const countryCode = "+91";
            const phoneNumber = phoneInput.value;
            const fullPhoneNumber = countryCode + phoneNumber;
            
            sendOtpBtn.disabled = true;
            sendOtpBtn.textContent = 'Sending...';

            firebase.auth().signInWithPhoneNumber(fullPhoneNumber, recaptchaVerifier)
                .then((result) => {
                    confirmationResult = result;
                    showOtpForm(fullPhoneNumber);
                }).catch((error) => {
                    console.error("ðŸ”¥ Firebase OTP Error:", error);
                    alert(`Failed to send OTP. Check console for details. Error: ${error.code}`);
                }).finally(() => {
                    sendOtpBtn.disabled = false;
                    sendOtpBtn.textContent = 'Send Code';
                });
        });

        otpForm.addEventListener('submit', (e) => {
            e.preventDefault();
            let otp = '';
            otpInputs.forEach(input => { otp += input.value; });

            if (otp.length !== 6 || !confirmationResult) {
                otpError.classList.remove('hidden');
                return;
            }

            verifyOtpBtn.disabled = true;
            verifyOtpBtn.textContent = 'Verifying...';

            confirmationResult.confirm(otp).then(async (result) => {
                const user = result.user;
                const idToken = await user.getIdToken();
                localStorage.setItem("mednote_id_token", idToken);
                window.location.href = "/"; // Redirect to main app
            }).catch((error) => {
                console.error("ðŸ”¥ OTP Verification Error:", error);
                otpError.classList.remove('hidden');
            }).finally(() => {
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.textContent = 'Verify';
            });
        });

        changePhoneBtn.addEventListener('click', showPhoneForm);
        
        // --- OTP Input Handling ---
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', () => {
                if (input.value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === "Backspace" && !input.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text');
                if (pasteData.length === 6) {
                    otpInputs.forEach((box, i) => { box.value = pasteData[i]; });
                    verifyOtpBtn.focus();
                }
            });
        });

        // --- Resend OTP Timer ---
        let timerInterval;
        function startResendTimer() {
            let timeLeft = 30;
            resendOtpBtn.disabled = true;
            resendTimer.textContent = `(${timeLeft}s)`;
            timerInterval = setInterval(() => {
                timeLeft--;
                resendTimer.textContent = `(${timeLeft}s)`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    resendOtpBtn.disabled = false;
                    resendTimer.textContent = '';
                }
            }, 1000);
        }

        resendOtpBtn.addEventListener('click', () => {
            phoneForm.dispatchEvent(new Event('submit'));
        });
    </script>
</body>
</html>
